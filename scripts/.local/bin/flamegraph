#!/usr/bin/env bash

function flamegraph-pipeline-1() { 
    $1 &
    perf record -F 99 -p $! -g -- sleep 60
}

function flamegraph-pipeline-1-pid() {
    perf record -F 99 -p $1 -g -- sleep 60
}

function flamegraph-pipeline-1-2-python() {
    python -m flamegraph -o script.folded $1
}

function flamegraph-pipeline-2() {
    perf script > script.perf
    stackcollapse-perf.pl script.perf > script.folded
}

function flamegraph-pipeline-3() {
    flamegraph.pl script.folded > script.svg 
    xdg-open script.svg
    rm -rf script.svg
}

[ -z "$1" ] && [ -z "$2" ] exit

case $1 in
    "program")
        flamegraph-pipeline-1 $2
        flamegraph-pipeline-2
        flamegraph-pipeline-3
        ;;
    "pid")
        flamegraph-pipeline-1-pid $2
        flamegraph-pipeline-2
        flamegraph-pipeline-3
        ;;
    "python")
        flamegraph-pipeline-1-2-python $2 
        flamegraph-pipeline-3
        ;;
esac

